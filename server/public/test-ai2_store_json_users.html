<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Aggregator Chat</title>
  <style>
    :root{
      --primary:#2563eb; --primary-600:#1d4ed8;
      --bg:#f6f7f9; --panel:#fff; --muted:#f0f0f0; --text:#111827; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;display:flex;height:100vh;background:var(--bg);color:var(--text)}
    /* Sidebar minimal */
    #sidebar{
      width:240px;background:#fff;border-right:1px solid var(--border);
      display:flex;flex-direction:column;padding:12px;gap:10px
    }
    .sideTop{display:flex;align-items:center;justify-content:space-between;gap:8px}
    #who{font-weight:700}
    .ghostBtn{background:#fff;border:1px solid var(--border);padding:.4rem .55rem;border-radius:8px;cursor:pointer;font-size:.9rem}
    .ghostBtn:hover{background:#f9fafb}
    #chatList{flex:1;overflow:auto;padding-right:4px}
    .chatItem{
      padding:.65rem .7rem;border-radius:10px;cursor:pointer;margin-bottom:.45rem;
      background:var(--muted);font-weight:600;text-align:center;
    }
    .chatItem.active{background:#e0e7ff;outline:2px solid #c7d2fe}
    /* Main */
    #main{flex:1;display:flex;flex-direction:column;padding:12px;gap:12px}
    .topBar{display:flex;align-items:center;justify-content:space-between;gap:.75rem}
    .providers{display:flex;gap:.5rem;flex-wrap:wrap}
    .provider{padding:.45rem .75rem;border:2px solid #d1d5db;border-radius:999px;cursor:pointer;transition:.15s;font-size:.9rem;background:#fff}
    .provider.active{border-color:var(--primary);background:#eff6ff;color:#1e3a8a}
    #chatWindow{flex:1;background:var(--panel);border-radius:12px;padding:1rem;overflow-y:auto;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .message{margin-bottom:.85rem;padding:.6rem .85rem;border-radius:12px;max-width:75%;word-wrap:break-word;white-space:pre-wrap}
    .userMsg{background:var(--primary);color:#fff;margin-left:auto}
    .aiMsg{background:var(--muted);color:#111;margin-right:auto}
    #inputArea{display:flex;gap:.5rem;align-items:flex-end}
    #prompt{flex:1;padding:.6rem .7rem;font-size:1rem;border-radius:10px;border:1px solid #d1d5db;min-height:56px;resize:vertical;max-height:40vh}
    #sendBtn{padding:.6rem 1rem;border-radius:10px;border:none;background:var(--primary);color:#fff;cursor:pointer;height:56px}
    #sendBtn:hover{background:var(--primary-600)}
  </style>
</head>
<body>
  <!-- SIDEBAR: solo Chat 1, Chat 2, Chat 3... -->
  <aside id="sidebar">
    <div class="sideTop">
      <div>Utente: <span id="who">‚Äî</span></div>
      <div style="display:flex; gap:6px">
        <button class="ghostBtn" id="switchUserBtn" title="Cambia utente">Cambia</button>
        <button class="ghostBtn" id="reloadBtn" title="Ricarica">‚Üª</button>
      </div>
    </div>
    <div id="chatList"></div>
    <button class="ghostBtn" id="newChatBtn" title="Crea Chat n+1">+ Nuova Chat</button>
  </aside>

  <!-- MAIN -->
  <main id="main">
    <div class="topBar">
      <div class="providers" id="providers">
        <div class="provider active" data-provider="openai" title="openai/gpt-4o-mini">OpenAI</div>
        <div class="provider" data-provider="anthropic" title="anthropic/claude-haiku-4.5">Anthropic</div>
        <div class="provider" data-provider="xai" title="x-ai/grok-4-fast">X-AI</div>
        <div class="provider" data-provider="google" title="google/gemini-2.5-flash-preview-09-2025">Google</div>
        <div class="provider" data-provider="meta" title="meta-llama/llama-3.1-70b-instruct">Meta</div>
      </div>
    </div>

    <div id="chatWindow">üí¨ Seleziona ‚ÄúChat 1 / Chat 2 ‚Ä¶‚Äù a sinistra o scrivi un messaggio per iniziare.</div>

    <div id="inputArea">
      <textarea id="prompt" placeholder="Scrivi qui il tuo messaggio‚Ä¶ (Invio invia, Shift+Invio va a capo)"></textarea>
      <button id="sendBtn">Invia</button>
    </div>
  </main>

  <script>
    // ===== CONFIG =====
    const DEFAULT_PORT = "http://localhost:3000";
    const BASE_URL = (location.origin && location.origin.includes("localhost:3000")) ? location.origin : DEFAULT_PORT;

    // ===== STATO =====
    let selectedProvider = "openai";
    let USER_ID = null;     // un solo user_id per tutto
    let messages = [];      // tutti i messaggi dal backend (chats[])
    let logs = [];          // tutti i logs dal backend (per contare scambi)
    let sessions = [];      // [{start,end}] sugli indici dei LOG (non messaggi). end √® dinamico per l‚Äôultima chat.
    let currentSession = 0; // indice chat attiva

    // ===== UI refs =====
    const providersEls = document.querySelectorAll(".provider");
    const chatWindow = document.getElementById("chatWindow");
    const promptEl = document.getElementById("prompt");
    const sendBtn = document.getElementById("sendBtn");
    const newChatBtn = document.getElementById("newChatBtn");
    const reloadBtn = document.getElementById("reloadBtn");
    const switchUserBtn = document.getElementById("switchUserBtn");
    const whoEl = document.getElementById("who");
    const chatList = document.getElementById("chatList");

    // ===== Provider switch =====
    providersEls.forEach(btn => {
      btn.addEventListener("click", () => {
        providersEls.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedProvider = btn.dataset.provider;
      });
    });

    // ===== SESSIONS STORAGE per utente =====
    function sessionsKey(){ return `aa_sessions_${USER_ID}`; }
    function loadSessions(){
      const raw = localStorage.getItem(sessionsKey());
      sessions = raw ? JSON.parse(raw) : [];
    }
    function saveSessions(){
      localStorage.setItem(sessionsKey(), JSON.stringify(sessions));
    }

    // ===== RENDER =====
    function renderSidebar(){
      chatList.innerHTML = "";
      if (sessions.length === 0){
        const div = document.createElement("div");
        div.className = "chatItem active";
        div.textContent = "Chat 1";
        chatList.appendChild(div);
        return;
      }
      sessions.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "chatItem" + (i===currentSession ? " active" : "");
        div.textContent = `Chat ${i+1}`;
        div.addEventListener("click", ()=>{
          currentSession = i;
          renderSidebar();
          renderChatWindow();
        });
        chatList.appendChild(div);
      });
    }

    function sessionMsgSlice(sess){
      // Ogni log = 1 scambio (2 messaggi: user+assistant).
      // Calcoliamo start/end su messages (che sono role/user|assistant).
      const totalLogs = logs.length;
      const startLog = Math.max(0, Math.min(sess.start, totalLogs));
      const endLog = (sess === sessions[sessions.length-1])
                      ? totalLogs // ultima chat segue la crescita dei logs
                      : Math.max(startLog, Math.min(sess.end, totalLogs));
      const startMsgIdx = startLog * 2;
      const endMsgIdx = endLog * 2;
      return messages.slice(startMsgIdx, endMsgIdx);
    }

    function renderChatWindow(){
      chatWindow.innerHTML = "";
      if (!sessions.length){
        chatWindow.textContent = "üí¨ Nessun messaggio ancora. Scrivi qui sotto per iniziare.";
        return;
      }
      const view = sessionMsgSlice(sessions[currentSession]);
      if (!view.length){
        chatWindow.textContent = "üí¨ Nessun messaggio ancora in questa chat.";
        return;
      }
      view.forEach(msg => {
        const wrap = document.createElement("div");
        wrap.className = "message " + (msg.role === "user" ? "userMsg" : "aiMsg");
        wrap.textContent = msg.content || "";
        chatWindow.appendChild(wrap);
      });
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // ===== BACKEND I/O =====
    async function loadAllFromServer(){
      if (!USER_ID) return;
      try {
        const res = await fetch(`${BASE_URL}/api/chats/${encodeURIComponent(USER_ID)}`);
        const data = await res.json();
        messages = data?.chats || [];
        logs = data?.logs || [];

        // Se non ci sono sessioni salvate per questo utente, creane una di default
        if (sessions.length === 0){
          // Se esistono gi√† scambi, la Chat 1 copre tutto finora
          sessions = [{ start: 0, end: logs.length }];
          currentSession = 0;
          saveSessions();
        } else {
          // Mantieni le esistenti; l‚Äôultima chat segue sempre i nuovi logs
          // Se per qualche motivo end < start, normalizza
          sessions = sessions.map((s, idx) => {
            const start = Math.max(0, Math.min(s.start, logs.length));
            const end = (idx === sessions.length - 1) ? Math.max(start, logs.length)
                                                     : Math.max(start, Math.min(s.end ?? start, logs.length));
            return { start, end };
          });
          saveSessions();
        }

        renderSidebar();
        renderChatWindow();
      } catch (err) {
        console.warn("Impossibile caricare chat dal backend:", err);
      }
    }

    async function sendMessage(text){
      const endpoint = `${BASE_URL}/api/${selectedProvider}`;
      const body = { user_id: USER_ID, message: text };
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (!res.ok){
        throw new Error(data?.details?.error || data?.error || "Errore sconosciuto");
      }
      return data;
    }

    // ===== AZIONI =====
    async function handleSend(){
      const text = promptEl.value.trim();
      if (!text) return;
      if (!USER_ID) { alert("Seleziona/Inserisci prima un utente."); return; }
      if (!sessions.length){
        sessions = [{ start: 0, end: 0 }]; currentSession = 0; saveSessions();
      }

      // UI ottimista nella chat corrente (append oltre l‚Äôend attuale)
      const lastEndBefore = logs.length;
      const optimisticUser = { role:"user", content:text };
      messages.push(optimisticUser);
      // se numero messaggi dispari, mancher√† l'assistant finch√© non risponde
      renderChatWindow();
      promptEl.value = "";

      try{
        const data = await sendMessage(text);
        messages.push({ role:"assistant", content:data.content || "" });
        renderChatWindow();

        // Ricarica stato reale (per aggiornare logs)
        await loadAllFromServer();

        // Aggiorna end della chat corrente all‚Äôultimo log
        sessions[currentSession].end = logs.length;
        // Assicurati che l‚Äôultima chat rimanga dinamica
        if (currentSession === sessions.length - 1){
          sessions[currentSession].end = logs.length;
        }
        saveSessions();
        renderSidebar();
        renderChatWindow();
      }catch(err){
        alert("Errore: " + err.message);
      }
    }

    sendBtn.addEventListener("click", handleSend);
    promptEl.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); handleSend(); }
    });

    newChatBtn.addEventListener("click", ()=>{
      // Crea una nuova chat che parte dall‚Äôattuale numero di logs
      const start = logs.length;
      sessions.push({ start, end: start }); // end crescer√† con i nuovi scambi
      currentSession = sessions.length - 1;
      saveSessions();
      renderSidebar();
      renderChatWindow();
    });

    reloadBtn.addEventListener("click", loadAllFromServer);

    switchUserBtn.addEventListener("click", ()=>{
      localStorage.removeItem("aa_username");
      USER_ID = null; messages=[]; logs=[]; sessions=[]; currentSession=0;
      askUsername(true);
    });

    // ===== Login utente all'avvio =====
    function askUsername(force=false){
      let defaultName = localStorage.getItem("aa_username") || "";
      if (!defaultName || force) {
        let name = null;
        while (!name) {
          name = prompt("Inserisci il nome utente (sar√† usato come user_id):", defaultName || "");
          if (name === null) break;
          name = (name || "").trim();
          if (!name) alert("Il nome utente non pu√≤ essere vuoto.");
        }
        if (name) {
          USER_ID = name;
          localStorage.setItem("aa_username", USER_ID);
        } else if (!defaultName) {
          USER_ID = "anonymous";
          localStorage.setItem("aa_username", USER_ID);
        }
      } else {
        USER_ID = defaultName;
      }
      whoEl.textContent = USER_ID || "‚Äî";

      // carica sessioni dell‚Äôutente e poi i dati reali
      loadSessions();
      loadAllFromServer();
    }

    // ===== Boot =====
    (function boot(){ askUsername(false); })();
  </script>
</body>
</html>
